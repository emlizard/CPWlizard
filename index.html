<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPW & CPWG Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --accent: #06b6d4;
      --accent-dark: #0891b2;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --bg-light: #ffffff;
      --bg-dark: #0f172a;
      --surface-light: #f8fafc;
      --surface-dark: #1e293b;
      --card-light: #ffffff;
      --card-dark: #334155;
      --text-primary-light: #0f172a;
      --text-primary-dark: #f1f5f9;
      --text-secondary-light: #64748b;
      --text-secondary-dark: #94a3b8;
      --border-light: #e2e8f0;
      --border-dark: #475569;
      --shadow-light: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-medium: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-large: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="light"] {
      --bg: var(--bg-light);
      --surface: var(--surface-light);
      --card: var(--card-light);
      --text-primary: var(--text-primary-light);
      --text-secondary: var(--text-secondary-light);
      --border: var(--border-light);
      --shadow: var(--shadow-light);
    }

    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --surface: var(--surface-dark);
      --card: var(--card-dark);
      --text-primary: var(--text-primary-dark);
      --text-secondary: var(--text-secondary-dark);
      --border: var(--border-dark);
      --shadow: var(--shadow-medium);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.6;
      transition: var(--transition);
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        45deg,
        rgba(37, 99, 235, 0.03) 0%,
        rgba(6, 182, 212, 0.03) 50%,
        rgba(16, 185, 129, 0.03) 100%
      );
      z-index: -1;
      animation: gradientShift 8s ease-in-out infinite;
    }

    @keyframes gradientShift {
      0%, 100% { transform: translateX(0%) rotate(0deg); }
      50% { transform: translateX(5%) rotate(1deg); }
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      transition: var(--transition);
    }

    [data-theme="dark"] .header {
      background: rgba(15, 23, 42, 0.9);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-toggle {
      background: none;
      border: 2px solid var(--border);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
    }

    .theme-toggle:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(1.1);
    }

    /* Main Content */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .hero {
      text-align: center;
      margin-bottom: 3rem;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .hero p {
      font-size: 1.125rem;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto 1rem;
    }

    .reference-note {
      font-size: 0.9rem;
      color: var(--accent);
      font-style: italic;
      margin-top: 0.5rem;
    }

    /* Card System */
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-bottom: 2rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transform: scaleX(0);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-large);
    }

    .card:hover::before {
      transform: scaleX(1);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    .grid-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    /* Form Controls */
    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-label {
      display: block;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .input-field {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text-primary);
      font-size: 1rem;
      transition: var(--transition);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-unit {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-small {
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
    }

    /* Structure Diagrams */
    .diagram-container {
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(6, 182, 212, 0.05));
      border-radius: var(--radius-lg);
      margin-bottom: 1rem;
    }

    .diagram-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .diagram {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      border: 2px dashed var(--border);
      position: relative;
      overflow: hidden;
    }

    .diagram::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80%;
      height: 2px;
      background: var(--primary);
      transform: translate(-50%, -50%);
    }

    .diagram-cpw::after {
      content: 'W';
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-weight: 600;
      color: var(--primary);
    }

    .diagram-cpwg::before {
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .diagram-cpwg::after {
      content: 'Ground Plane';
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: var(--accent);
    }

    /* Results Display */
    .result-display {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(6, 182, 212, 0.05));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    .result-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .result-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr;
    }

    .result-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      transition: var(--transition);
    }

    .result-item:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    .result-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .result-value {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .result-value.updated {
      color: var(--primary);
      animation: resultUpdate 0.5s ease-out;
    }

    @keyframes resultUpdate {
      0% {
        background: rgba(37, 99, 235, 0.2);
        transform: scale(1.05);
      }
      100% {
        background: transparent;
        transform: scale(1);
      }
    }

    /* Calculation Sections */
    .calc-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .calc-section h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Formula Sections */
    .formula-section {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .formula-section h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .formula-content {
      color: var(--text-primary);
      line-height: 1.8;
    }

    .formula-content p {
      margin-bottom: 1rem;
    }

    /* Info Boxes */
    .info-box {
      background: rgba(6, 182, 212, 0.1);
      border-left: 4px solid var(--accent);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .info-box h4 {
      color: var(--accent);
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .info-box p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .debug-section {
      background: rgba(37, 99, 235, 0.1);
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 var(--radius) var(--radius) 0;
      font-size: 0.85rem;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      white-space: pre-wrap;
      display: none;
      line-height: 1.4;
    }

    .debug-section.show {
      display: block;
    }

    /* Loading State */
    .calculating {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .calculating::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      border-top-color: transparent;
      transform: translate(-50%, -50%);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }

    /* Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: fadeInUp 0.6s ease-out;
    }

    /* Toggle Switch for Debug */
    .debug-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .debug-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    /* Responsive Design */
    @media (max-width: 968px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      
      .container {
        padding: 1rem;
      }
      
      .card {
        padding: 1.5rem;
      }

      .hero h1 {
        font-size: 2rem;
      }
    }

    /* Error Display */
    .error-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: 2px solid var(--error);
      border-radius: var(--radius);
      padding: 1rem;
      z-index: 1000;
      animation: fadeInUp 0.3s ease-out;
      box-shadow: var(--shadow-large);
      max-width: 300px;
      color: var(--error);
    }
  </style>
</head>
<body data-theme="light">
  <header class="header">
    <div class="header-content">
      <div class="page-title">CPW & CPWG Calculator</div>
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
    </div>
  </header>

  <div class="container">
    <!-- Hero Section -->
    <div class="hero">
      <h1>CPW & CPWG Calculator</h1>
      <p>Accurate calculation of characteristic impedance and effective permittivity for Coplanar Waveguide (CPW) and Coplanar Waveguide with Ground (CPWG) transmission lines.</p>
      <div class="reference-note">
        Advanced formulas reflecting the physical differences between CPW and CPWG structures
      </div>
    </div>

    <!-- Main Calculator Grid -->
    <div class="grid grid-3">
      <!-- Input Parameters -->
      <div class="card animate-in">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-sliders-h"></i>
          </div>
          Input Parameters
        </div>
        
        <div style="margin-bottom: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1rem;">Common Parameters</h4>
          
          <div class="input-group">
            <label class="input-label" for="signal-width">
              Signal Line Width (W) <span class="input-unit">[mm]</span>
            </label>
            <input type="number" id="signal-width" class="input-field" step="any" value="2.0" min="0">
          </div>
          
          <div class="input-group">
            <label class="input-label" for="substrate-thickness">
              Substrate Thickness (h) <span class="input-unit">[mm]</span>
            </label>
            <input type="number" id="substrate-thickness" class="input-field" step="any" value="1.6" min="0">
          </div>
          
          <div class="input-group">
            <label class="input-label" for="conductor-thickness">
              Conductor Thickness (t) <span class="input-unit">[µm]</span>
            </label>
            <input type="number" id="conductor-thickness" class="input-field" step="any" value="35" min="0">
          </div>
          
          <div class="input-group">
            <label class="input-label" for="permittivity">
              Relative Permittivity (εᵣ)
            </label>
            <input type="number" id="permittivity" class="input-field" step="any" value="4.4" min="1">
          </div>
          
          <div class="input-group">
            <label class="input-label" for="frequency">
              Frequency (f) <span class="input-unit">[GHz]</span>
            </label>
            <input type="number" id="frequency" class="input-field" step="any" value="1.0" min="0">
          </div>
        </div>

        <!-- Calculation Methods -->
        <div class="calc-section">
          <h3>
            <i class="fas fa-arrow-right"></i>
            Slot Width → Impedance
          </h3>
          
          <div class="input-group">
            <label class="input-label" for="slot-width">
              Slot Width (S) <span class="input-unit">[mm]</span>
            </label>
            <input type="number" id="slot-width" class="input-field" step="any" value="0.5" min="0">
          </div>
          
          <button type="button" class="btn btn-full" onclick="calculateImpedance()">
            <i class="fas fa-calculator"></i>
            Calculate Z₀
          </button>
        </div>

        <div class="calc-section">
          <h3>
            <i class="fas fa-arrow-left"></i>
            Impedance → Slot Width
          </h3>
          
          <div class="input-group">
            <label class="input-label" for="target-impedance">
              Target Impedance (Z₀) <span class="input-unit">[Ω]</span>
            </label>
            <input type="number" id="target-impedance" class="input-field" step="any" value="50" min="0">
          </div>
          
          <button type="button" class="btn btn-secondary btn-full" onclick="calculateSlotWidth()">
            <i class="fas fa-search"></i>
            Find Slot Width
          </button>
        </div>
      </div>

      <!-- CPW Results -->
      <div class="card animate-in">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-wave-square"></i>
          </div>
          CPW Structure
        </div>
        
        <div class="diagram-container">
          <div class="diagram-title">Coplanar Waveguide</div>
          <div class="diagram diagram-cpw">
            <img src="https://emlizard.github.io/main-page/images/diagram_cpw.png" alt="CPW cross-section">
          </div>
            <div style="margin-top: 2rem;">
              Signal line and ground planes<br>on the same layer
            </div>
          </div>
        </div>
        
        <div class="result-display">
          <div class="result-title">
            <i class="fas fa-chart-line"></i>
            CPW Results
          </div>
          
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">Characteristic Impedance</div>
              <div class="result-value" id="cpw-impedance">-- Ω</div>
            </div>
            
            <div class="result-item">
              <div class="result-label">Slot Width</div>
              <div class="result-value" id="cpw-slot">-- mm</div>
            </div>
            
            <div class="result-item">
              <div class="result-label">Effective Permittivity</div>
              <div class="result-value" id="cpw-permittivity">--</div>
            </div>
          </div>
          
          <div class="debug-toggle">
            <input type="checkbox" id="cpw-debug-toggle" onchange="toggleDebug('cpw')">
            <label for="cpw-debug-toggle">Show debug information</label>
          </div>
          
          <div class="debug-section" id="cpw-debug">
            Debug information will appear here when enabled.
          </div>
        </div>
      </div>

      <!-- CPWG Results -->
      <div class="card animate-in">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-layer-group"></i>
          </div>
          CPWG Structure
        </div>
        
        <div class="diagram-container">
          <div class="diagram-title">CPW with Ground Plane</div>
          <div class="diagram diagram-cpwg">
            <img src="https://emlizard.github.io/main-page/images/diagram_cpwg.png" alt="CPWG cross-section">
          </div>
            <div style="margin-top: 2rem;">
              CPW + bottom ground plane
            </div>
          </div>
        </div>
        
        <div class="result-display">
          <div class="result-title">
            <i class="fas fa-chart-line"></i>
            CPWG Results
          </div>
          
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">Characteristic Impedance</div>
              <div class="result-value" id="cpwg-impedance">-- Ω</div>
            </div>
            
            <div class="result-item">
              <div class="result-label">Slot Width</div>
              <div class="result-value" id="cpwg-slot">-- mm</div>
            </div>
            
            <div class="result-item">
              <div class="result-label">Effective Permittivity</div>
              <div class="result-value" id="cpwg-permittivity">--</div>
            </div>
          </div>
          
          <div class="debug-toggle">
            <input type="checkbox" id="cpwg-debug-toggle" onchange="toggleDebug('cpwg')">
            <label for="cpwg-debug-toggle">Show debug information</label>
          </div>
          
          <div class="debug-section" id="cpwg-debug">
            Debug information will appear here when enabled.
          </div>
        </div>
      </div>
    </div>

    <!-- Physical Theory -->
    <div class="card animate-in">
      <div class="card-title">
        <div class="card-icon">
          <i class="fas fa-atom"></i>
        </div>
        Physical Differences: CPW vs CPWG
      </div>
      
      <div class="info-box">
        <h4>Electromagnetic Field Distribution</h4>
        <p>
          <strong>CPW:</strong> Fields are distributed approximately 50/50 between air and dielectric substrate. The structure resembles a "slot line" with electromagnetic coupling through both media.<br><br>
          <strong>CPWG:</strong> The bottom ground plane confines more electromagnetic fields within the dielectric substrate, resulting in higher field concentration and increased effective permittivity.
        </p>
      </div>

      <div class="info-box">
        <h4>Mathematical Model Differences</h4>
        <p>
          <strong>Substrate Correction Factor (k₁):</strong><br>
          • CPW uses <em>sinh()</em> functions modeling infinite substrate boundaries<br>
          • CPWG uses <em>tanh()</em> functions accounting for the finite substrate with bottom ground<br><br>
          <strong>Effective Permittivity Formula:</strong><br>
          • CPW: Averaging approach → (εᵣ + 1)/2 + correction<br>
          • CPWG: Field filling approach → 1 + (εᵣ - 1) × filling_factor
        </p>
      </div>

      <div class="info-box">
        <h4>Practical Implications</h4>
        <p>
          For the same geometry, CPWG will typically have:<br>
          • Higher effective permittivity (εₑff) due to field confinement<br>
          • Lower characteristic impedance (Z₀)<br>
          • Better field confinement within the substrate<br>
          • Reduced radiation losses<br>
          • More predictable performance across frequency
        </p>
      </div>
    </div>

    <!-- Mathematical Formulas -->
    <div class="card animate-in">
      <div class="card-title">
        <div class="card-icon">
          <i class="fas fa-square-root-alt"></i>
        </div>
        Mathematical Formulas
      </div>
      
      <div class="formula-section">
        <h3>1. Common Parameters</h3>
        <div class="formula-content">
          <p><strong>Effective Conductor Width (thickness correction):</strong></p>
          \[
          W_{\text{eff}} = W + \frac{t}{\pi} \left[ 1 + \ln\left(\frac{4\pi W}{t}\right) \right]
          \]
          
          <p><strong>Conductor Width Ratio:</strong></p>
          \[
          k = \frac{W_{\text{eff}}}{W_{\text{eff}} + 2S}
          \]
        </div>
      </div>

      <div class="formula-section">
        <h3>2. CPW Formulas</h3>
        <div class="formula-content">
          <p><strong>Substrate Thickness Correction (infinite boundaries):</strong></p>
          \[
          k_1^{\text{CPW}} = \frac{\sinh\left(\frac{\pi W_{\text{eff}}}{4h}\right)}{\sinh\left(\frac{\pi (W_{\text{eff}} + 2S)}{4h}\right)}
          \]
          
          <p><strong>Static Effective Permittivity:</strong></p>
          \[
          \varepsilon_{\text{eff,0}}^{\text{CPW}} = \frac{\varepsilon_r + 1}{2} + \frac{\varepsilon_r - 1}{2} \cdot \frac{K(k_1^{\text{CPW}})}{K'(k_1^{\text{CPW}})}
          \]
          
          <p><strong>Characteristic Impedance:</strong></p>
          \[
          Z_0^{\text{CPW}} = \frac{30\pi}{\sqrt{\varepsilon_{\text{eff}}^{\text{CPW}}}} \cdot \frac{K'(k)}{K(k)}
          \]
        </div>
      </div>

      <div class="formula-section">
        <h3>3. CPWG Formulas</h3>
        <div class="formula-content">
          <p><strong>Substrate Thickness Correction (finite substrate with bottom ground):</strong></p>
          \[
          k_1^{\text{CPWG}} = \frac{\tanh\left(\frac{\pi W_{\text{eff}}}{4h}\right)}{\tanh\left(\frac{\pi (W_{\text{eff}} + 2S)}{4h}\right)}
          \]
          
          <p><strong>Static Effective Permittivity (Wadell standard formula):</strong></p>
          \[
          \varepsilon_{\text{eff,0}}^{\text{CPWG}} = \frac{\varepsilon_r + 1}{2} \cdot \frac{K(k_1^{\text{CPWG}})}{K'(k_1^{\text{CPWG}})} + \frac{\varepsilon_r - 1}{2} \cdot \frac{K(k)}{K'(k)}
          \]
          
          <p><strong>Characteristic Impedance:</strong></p>
          \[
          Z_0^{\text{CPWG}} = \frac{30\pi}{\sqrt{\varepsilon_{\text{eff}}^{\text{CPWG}}}} \cdot \frac{K'(k)}{K(k)}
          \]
        </div>
      </div>

      <div class="formula-section">
        <h3>4. Frequency Dispersion</h3>
        <div class="formula-content">
          <p><strong>Characteristic Frequency:</strong></p>
          \[
          f_p = \frac{c}{4h\sqrt{\varepsilon_r}}
          \]
          
          <p><strong>Frequency-Dependent Effective Permittivity:</strong></p>
          \[
          \varepsilon_{\text{eff}}(f) = \varepsilon_{\text{eff,0}} + (\varepsilon_r - \varepsilon_{\text{eff,0}}) \left(1 - e^{-\alpha f/f_p} \right)
          \]
          <p>where α = 1.0 for CPW, α = 1.2 for CPWG (enhanced dispersion)</p>
          
          <p><strong>Complete Elliptic Integral Ratio (Hilberg approximation):</strong></p>
          \[
          \frac{K(k)}{K'(k)} = \begin{cases}
          \frac{1}{\pi} \ln\left(2 \frac{1+\sqrt{k}}{1-\sqrt{k}}\right) & \text{if } k \leq \frac{1}{\sqrt{2}} \\[0.5em]
          \frac{\pi}{\ln\left(2 \frac{1+\sqrt{k'}}{1-\sqrt{k'}}\right)} & \text{if } k > \frac{1}{\sqrt{2}}
          \end{cases}
          \]
          <p>where \( k' = \sqrt{1-k^2} \) is the complementary modulus</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // MathJax Configuration
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };

    // Physical Constants
    const SPEED_OF_LIGHT = 2.99792458e8; // m/s
    const PI = Math.PI;

    // Theme Management
    function toggleTheme() {
      const body = document.body;
      const themeIcon = document.getElementById('themeIcon');
      const currentTheme = body.getAttribute('data-theme');
      
      if (currentTheme === 'light') {
        body.setAttribute('data-theme', 'dark');
        themeIcon.className = 'fas fa-sun';
      } else {
        body.setAttribute('data-theme', 'light');
        themeIcon.className = 'fas fa-moon';
      }
    }

    // Utility Functions
    function getInputParameters() {
      return {
        W: parseFloat(document.getElementById("signal-width").value) / 1000,        // Convert mm to m
        h: parseFloat(document.getElementById("substrate-thickness").value) / 1000, // Convert mm to m
        t: parseFloat(document.getElementById("conductor-thickness").value) * 1e-6,  // Convert µm to m
        eps_r: parseFloat(document.getElementById("permittivity").value),
        f: parseFloat(document.getElementById("frequency").value) * 1e9              // Convert GHz to Hz
      };
    }

    function validateInputs(params) {
      if (params.W <= 0 || params.h <= 0 || params.t < 0 || params.eps_r < 1 || params.f < 0) {
        throw new Error('Invalid input parameters');
      }
    }

    function updateResultValue(elementId, value, unit = '') {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value + unit;
        element.classList.add('updated');
        setTimeout(() => element.classList.remove('updated'), 500);
      }
    }

    function updateDebugInfo(type, info) {
      const element = document.getElementById(`${type}-debug`);
      if (element) {
        element.textContent = info;
      }
    }

    function toggleDebug(type) {
      const debugSection = document.getElementById(`${type}-debug`);
      const checkbox = document.getElementById(`${type}-debug-toggle`);
      
      if (checkbox.checked) {
        debugSection.classList.add('show');
      } else {
        debugSection.classList.remove('show');
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        ${message}
      `;
      
      document.body.appendChild(errorDiv);
      setTimeout(() => errorDiv.remove(), 4000);
    }

    // Mathematical Functions
    function effectiveWidth(W, t, h) {
      if (t <= 0) return W;
      
      // Enhanced effective width calculation (Wadell, 1991)
      if (t < 0.1 * W) {
        return W + (t / PI) * (1 + Math.log(4 * PI * W / t));
      }
      
      return W + (t / PI) * Math.log(1 + (4 * Math.E * h) / t);
    }

    // Calculate K(k)/K'(k) ratio using Hilberg approximation
    // Returns: K(k)/K'(k) where K is complete elliptic integral of first kind
    // Input: k (elliptic modulus, 0 ≤ k ≤ 1)
    function ellipticIntegralRatio(k) {
      if (k < 0 || k > 1) return NaN;
      if (k === 0) return 0;
      if (k === 1) return Infinity;
      
      const k_threshold = 1.0 / Math.sqrt(2);
      
      if (k <= k_threshold) {
        // For k ≤ 1/√2, calculate K(k)/K'(k) directly
        const sqrt_k = Math.sqrt(k);
        return (1 / PI) * Math.log(2 * (1 + sqrt_k) / (1 - sqrt_k));
      } else {
        // For k > 1/√2, use reciprocal property: K(k)/K'(k) = 1/[K'(k)/K(k)]
        const kp = Math.sqrt(1 - k * k);  // k' = √(1-k²)
        const sqrt_kp = Math.sqrt(kp);
        const K_kp_over_K_k = (1 / PI) * Math.log(2 * (1 + sqrt_kp) / (1 - sqrt_kp));
        return 1 / K_kp_over_K_k;
      }
    }

    // CPW Calculation
    function calculateCPW(W, S, eps_r, h, t, f) {
      try {
        const W_eff = effectiveWidth(W, t, h);
        const k = W_eff / (W_eff + 2 * S);
        
        // CPW: sinh for infinite substrate model
        const arg1 = (PI * W_eff) / (4 * h);
        const arg2 = (PI * (W_eff + 2 * S)) / (4 * h);
        const k1 = Math.sinh(arg1) / Math.sinh(arg2);
        
        let debug = `CPW Calculation Debug:\n`;
        debug += `W_eff = ${(W_eff * 1000).toFixed(3)} mm\n`;
        debug += `k = ${k.toFixed(6)}\n`;
        debug += `k1 = ${k1.toFixed(6)} (using sinh)\n`;
        
        // Effective permittivity calculation
        let eps_eff;
        if (eps_r === 1) {
          eps_eff = 1;
          debug += `Air case: εₑff = 1\n`;
        } else {
          const K_k1_ratio = ellipticIntegralRatio(k1);
          let eps_eff_static = (eps_r + 1) / 2 + ((eps_r - 1) / 2) * K_k1_ratio;
          
          debug += `K(k1)/K'(k1) = ${K_k1_ratio.toFixed(6)}\n`;
          debug += `εₑff,static = ${eps_eff_static.toFixed(6)}\n`;
          
          // Frequency dispersion
          if (f > 0) {
            const f_p = SPEED_OF_LIGHT / (4 * h * Math.sqrt(eps_r));
            const dispersion_factor = 1 - Math.exp(-f / f_p);
            eps_eff = eps_eff_static + (eps_r - eps_eff_static) * dispersion_factor;
            
            debug += `f_p = ${(f_p / 1e9).toFixed(3)} GHz\n`;
            debug += `Dispersion factor = ${dispersion_factor.toFixed(6)}\n`;
            debug += `εₑff(f) = ${eps_eff.toFixed(6)}\n`;
          } else {
            eps_eff = eps_eff_static;
          }
        }
        
        // Characteristic impedance
        const K_ratio = ellipticIntegralRatio(k);  // K(k)/K'(k)
        const Z0 = (30 * PI / Math.sqrt(eps_eff)) / K_ratio;
        
        debug += `\nCharacteristic Impedance Calculation:\n`;
        debug += `K(k)/K'(k) = ${K_ratio.toFixed(6)}\n`;
        debug += `Z₀ = 30π/√εₑff × K'(k)/K(k)\n`;
        debug += `Z₀ = 30π/√εₑff / (K(k)/K'(k))\n`;
        debug += `Z₀ = ${Z0.toFixed(3)} Ω`;
        
        return { Z0, eps_eff, debug };
      } catch (error) {
        return { Z0: NaN, eps_eff: NaN, debug: `Error: ${error.message}` };
      }
    }

    // CPWG Calculation
    function calculateCPWG(W, S, eps_r, h, t, f) {
      try {
        const W_eff = effectiveWidth(W, t, h);
        const k = W_eff / (W_eff + 2 * S);
        
        // CPWG: tanh for finite substrate with bottom ground
        const arg1 = (PI * W_eff) / (4 * h);
        const arg2 = (PI * (W_eff + 2 * S)) / (4 * h);
        const k1 = Math.tanh(arg1) / Math.tanh(arg2);
        
        let debug = `CPWG Calculation Debug:\n`;
        debug += `W_eff = ${(W_eff * 1000).toFixed(3)} mm\n`;
        debug += `k = ${k.toFixed(6)}\n`;
        debug += `k1 = ${k1.toFixed(6)} (using tanh)\n`;
        
        // Effective permittivity calculation (Wadell standard formula)
        let eps_eff;
        if (eps_r === 1) {
          eps_eff = 1;
          debug += `Air case: εₑff = 1 (same as CPW)\n`;
        } else {
          const K_k1_ratio = ellipticIntegralRatio(k1);
          const K_k_ratio = ellipticIntegralRatio(k);
          
          // Wadell formula for CPWG: εₑff = (εᵣ+1)/2 × K(k₁)/K'(k₁) + (εᵣ-1)/2 × K(k)/K'(k)
          let eps_eff_static = (eps_r + 1) / 2 * K_k1_ratio + (eps_r - 1) / 2 * K_k_ratio;
          
          debug += `K(k1)/K'(k1) = ${K_k1_ratio.toFixed(6)}\n`;
          debug += `K(k)/K'(k) = ${K_k_ratio.toFixed(6)}\n`;
          debug += `εₑff,static = ${eps_eff_static.toFixed(6)} (Wadell formula)\n`;
          
          // Frequency dispersion (enhanced for CPWG)
          if (f > 0) {
            const f_p = SPEED_OF_LIGHT / (4 * h * Math.sqrt(eps_r));
            const dispersion_factor = 1 - Math.exp(-1.2 * f / f_p); // Enhanced dispersion
            eps_eff = eps_eff_static + (eps_r - eps_eff_static) * dispersion_factor;
            
            debug += `f_p = ${(f_p / 1e9).toFixed(3)} GHz\n`;
            debug += `Enhanced dispersion factor = ${dispersion_factor.toFixed(6)}\n`;
            debug += `εₑff(f) = ${eps_eff.toFixed(6)}\n`;
          } else {
            eps_eff = eps_eff_static;
          }
          
          // Physical constraint: εₑff should not exceed εᵣ
          if (eps_eff > eps_r) {
            eps_eff = eps_r * 0.99;
            debug += `Capped at 99% of εᵣ\n`;
          }
        }
        
        // Characteristic impedance
        const K_ratio = ellipticIntegralRatio(k);
        const Z0 = (30 * PI / Math.sqrt(eps_eff)) / K_ratio;
        
        debug += `K(k)/K'(k) = ${K_ratio.toFixed(6)}\n`;
        debug += `Z₀ = ${Z0.toFixed(3)} Ω`;
        
        return { Z0, eps_eff, debug };
      } catch (error) {
        return { Z0: NaN, eps_eff: NaN, debug: `Error: ${error.message}` };
      }
    }

    // Slot Width Optimizer (Newton-Raphson method)
    function findSlotWidth(targetZ0, W, eps_r, h, t, f, isCPWG = false) {
      const calculateZ0 = (S) => {
        const result = isCPWG ? calculateCPWG(W, S, eps_r, h, t, f) : calculateCPW(W, S, eps_r, h, t, f);
        return result.Z0;
      };
      
      // Initial bounds and guess
      let S_min = 0.001 * W;  // Minimum practical slot width
      let S_max = 20 * W;     // Maximum reasonable slot width
      let S = Math.sqrt(S_min * S_max); // Geometric mean as initial guess
      
      const tolerance = 1e-9;
      const maxIterations = 100;
      const dampingFactor = 0.7;
      
      for (let i = 0; i < maxIterations; i++) {
        // Ensure S is within bounds
        S = Math.max(S_min, Math.min(S, S_max));
        
        const Z_current = calculateZ0(S);
        
        if (isNaN(Z_current) || !isFinite(Z_current)) {
          console.warn(`Invalid Z0 at iteration ${i}: S = ${S * 1000} mm`);
          S = S * 0.9; // Reduce slot width
          continue;
        }
        
        const error = Z_current - targetZ0;
        
        if (Math.abs(error) < tolerance) {
          console.log(`Converged: S = ${(S * 1000).toFixed(3)} mm, Z0 = ${Z_current.toFixed(2)} Ω`);
          return S;
        }
        
        // Calculate numerical derivative
        const dS = Math.max(S * 1e-6, 1e-12);
        const Z_plus = calculateZ0(S + dS);
        const Z_minus = calculateZ0(S - dS);
        
        if (isNaN(Z_plus) || isNaN(Z_minus)) {
          console.warn(`Invalid derivative at iteration ${i}`);
          // Use bisection fallback
          if (error > 0) {
            S = S * 0.95;
          } else {
            S = S * 1.05;
          }
          continue;
        }
        
        const dZ_dS = (Z_plus - Z_minus) / (2 * dS);
        
        if (Math.abs(dZ_dS) < 1e-15) {
          console.warn(`Derivative too small at iteration ${i}`);
          // Use adaptive step
          if (error > 0) {
            S = S * 0.98;
          } else {
            S = S * 1.02;
          }
          continue;
        }
        
        // Newton-Raphson step with damping
        const S_next = S - dampingFactor * error / dZ_dS;
        
        // Ensure new S is within bounds
        const S_bounded = Math.max(S_min, Math.min(S_next, S_max));
        
        if (Math.abs(S_bounded - S) < tolerance * S) {
          console.log(`Converged: S = ${(S_bounded * 1000).toFixed(3)} mm after ${i + 1} iterations`);
          return S_bounded;
        }
        
        S = S_bounded;
      }
      
      console.error(`Failed to converge after ${maxIterations} iterations. Final S = ${(S * 1000).toFixed(3)} mm`);
      return S;
    }

    // Main Calculation Functions
    function calculateImpedance() {
      const button = event.target;
      button.classList.add('calculating');
      
      setTimeout(() => {
        try {
          const params = getInputParameters();
          validateInputs(params);
          
          const S = parseFloat(document.getElementById("slot-width").value) / 1000; // Convert mm to m
          
          if (isNaN(S) || S <= 0) {
            throw new Error('Invalid slot width value');
          }
          
          // Calculate both CPW and CPWG
          const cpwResult = calculateCPW(params.W, S, params.eps_r, params.h, params.t, params.f);
          const cpwgResult = calculateCPWG(params.W, S, params.eps_r, params.h, params.t, params.f);
          
          if (isNaN(cpwResult.Z0) || isNaN(cpwgResult.Z0)) {
            throw new Error('Calculation failed - check input parameters');
          }
          
          // Update CPW results
          updateResultValue('cpw-impedance', cpwResult.Z0.toFixed(2), ' Ω');
          updateResultValue('cpw-slot', (S * 1000).toFixed(3), ' mm');
          updateResultValue('cpw-permittivity', cpwResult.eps_eff.toFixed(4));
          updateDebugInfo('cpw', cpwResult.debug);
          
          // Update CPWG results
          updateResultValue('cpwg-impedance', cpwgResult.Z0.toFixed(2), ' Ω');
          updateResultValue('cpwg-slot', (S * 1000).toFixed(3), ' mm');
          updateResultValue('cpwg-permittivity', cpwgResult.eps_eff.toFixed(4));
          updateDebugInfo('cpwg', cpwgResult.debug);
          
        } catch (error) {
          console.error('Impedance calculation error:', error);
          showError('Calculation error: ' + error.message);
          clearResults();
        }
        
        button.classList.remove('calculating');
      }, 100);
    }

    function calculateSlotWidth() {
      const button = event.target;
      button.classList.add('calculating');
      
      setTimeout(() => {
        try {
          const params = getInputParameters();
          validateInputs(params);
          
          const targetZ0 = parseFloat(document.getElementById("target-impedance").value);
          
          if (isNaN(targetZ0) || targetZ0 <= 0) {
            throw new Error('Invalid target impedance value');
          }
          
          // Find slot widths for both CPW and CPWG
          const cpwSlot = findSlotWidth(targetZ0, params.W, params.eps_r, params.h, params.t, params.f, false);
          const cpwgSlot = findSlotWidth(targetZ0, params.W, params.eps_r, params.h, params.t, params.f, true);
          
          if (isNaN(cpwSlot) || isNaN(cpwgSlot) || cpwSlot <= 0 || cpwgSlot <= 0) {
            throw new Error('Failed to find valid slot width');
          }
          
          // Verify results
          const cpwResult = calculateCPW(params.W, cpwSlot, params.eps_r, params.h, params.t, params.f);
          const cpwgResult = calculateCPWG(params.W, cpwgSlot, params.eps_r, params.h, params.t, params.f);
          
          // Update CPW results
          updateResultValue('cpw-impedance', cpwResult.Z0.toFixed(2), ' Ω');
          updateResultValue('cpw-slot', (cpwSlot * 1000).toFixed(3), ' mm');
          updateResultValue('cpw-permittivity', cpwResult.eps_eff.toFixed(4));
          updateDebugInfo('cpw', cpwResult.debug);
          
          // Update CPWG results
          updateResultValue('cpwg-impedance', cpwgResult.Z0.toFixed(2), ' Ω');
          updateResultValue('cpwg-slot', (cpwgSlot * 1000).toFixed(3), ' mm');
          updateResultValue('cpwg-permittivity', cpwgResult.eps_eff.toFixed(4));
          updateDebugInfo('cpwg', cpwgResult.debug);
          
        } catch (error) {
          console.error('Slot width calculation error:', error);
          showError('Calculation error: ' + error.message);
          clearResults();
        }
        
        button.classList.remove('calculating');
      }, 100);
    }

    function clearResults() {
      updateResultValue('cpw-impedance', '--', ' Ω');
      updateResultValue('cpw-slot', '--', ' mm');
      updateResultValue('cpw-permittivity', '--');
      updateResultValue('cpwg-impedance', '--', ' Ω');
      updateResultValue('cpwg-slot', '--', ' mm');
      updateResultValue('cpwg-permittivity', '--');
      updateDebugInfo('cpw', 'Debug information will appear here when enabled.');
      updateDebugInfo('cpwg', 'Debug information will appear here when enabled.');
    }

    // Input Validation
    function setupInputValidation() {
      const inputs = document.querySelectorAll('.input-field');
      
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          const value = parseFloat(this.value);
          
          // Reset border color
          this.style.borderColor = '';
          this.title = '';
          
          // Validate based on input type
          if (this.id === 'permittivity') {
            if (isNaN(value) || value < 1) {
              this.style.borderColor = 'var(--error)';
              this.title = 'Relative permittivity must be ≥ 1';
            } else {
              this.style.borderColor = 'var(--success)';
              this.title = 'Valid relative permittivity';
            }
          } else if (this.id === 'frequency') {
            if (isNaN(value) || value < 0) {
              this.style.borderColor = 'var(--error)';
              this.title = 'Frequency must be ≥ 0';
            } else {
              this.style.borderColor = 'var(--success)';
              this.title = 'Valid frequency';
            }
          } else if (this.id === 'conductor-thickness') {
            if (isNaN(value) || value < 0) {
              this.style.borderColor = 'var(--error)';
              this.title = 'Conductor thickness must be ≥ 0';
            } else {
              this.style.borderColor = 'var(--success)';
              this.title = 'Valid conductor thickness';
            }
          } else {
            // All other inputs must be positive
            if (isNaN(value) || value <= 0) {
              this.style.borderColor = 'var(--error)';
              this.title = 'Value must be positive';
            } else {
              this.style.borderColor = 'var(--success)';
              this.title = 'Valid input';
            }
          }
        });
      });
    }

    // Keyboard Shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(event) {
        if (event.ctrlKey || event.metaKey) {
          switch(event.key) {
            case '1':
              event.preventDefault();
              calculateImpedance();
              break;
            case '2':
              event.preventDefault();
              calculateSlotWidth();
              break;
            case 'd':
              event.preventDefault();
              toggleTheme();
              break;
          }
        }
      });
    }

    // Animation Observer
    function setupAnimations() {
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.animationDelay = Math.random() * 0.3 + 's';
            entry.target.classList.add('animate-in');
          }
        });
      }, observerOptions);

      document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
      });
    }

    // Initialize Application
    document.addEventListener('DOMContentLoaded', function() {
      setupInputValidation();
      setupKeyboardShortcuts();
      setupAnimations();
      
      // Set initial theme
      const savedTheme = 'light';
      const themeIcon = document.getElementById('themeIcon');
      document.body.setAttribute('data-theme', savedTheme);
      themeIcon.className = 'fas fa-moon';
      
      console.log('CPW & CPWG Calculator initialized');
      console.log('Keyboard shortcuts: Ctrl+1 (Calculate Z₀), Ctrl+2 (Find Slot Width), Ctrl+D (Toggle Theme)');
    });
  </script>
</body>
</html>
